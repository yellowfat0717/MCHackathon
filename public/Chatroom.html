<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èŠå¤©å®¤</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    #messages { height: 70vh; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .message { margin: 5px 0; }
    .me { text-align: right; color: blue; }
    .other { text-align: left; color: green; }
  </style>
</head>
<body>
  <h2>ğŸ“© èŠå¤©å®¤</h2>
  <div id="messages"></div>
  <input id="msgInput" type="text" placeholder="è¼¸å…¥è¨Šæ¯..." />
  <button id="sendBtn">é€å‡º</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    import { firebaseConfig } from "./fundamental.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // å–å¾—ä½¿ç”¨è€…è§’è‰²
    const role = sessionStorage.getItem("role");
    const user = auth.currentUser;

    // å‡è¨­é€™è£¡å…ˆå›ºå®šä¸€å€‹å°è©±å°è±¡ï¼ˆæœªä¾†å¯ä»¥åšé¸å–®ï¼‰
    const teacherEmail = "teacher@test.com";
    const parentEmail = user.email; // å®¶é•·ç™»å…¥çš„ä¿¡ç®±
    const chatId = [teacherEmail, parentEmail].sort().join("_");
    const chatRef = doc(db, "chats", chatId);

    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    // ç›£è½èŠå¤©å®¤è¨Šæ¯
    onSnapshot(chatRef, (snap) => {
      if (snap.exists()) {
        const data = snap.data();
        messagesDiv.innerHTML = "";
        data.messages.forEach(m => {
          const div = document.createElement("div");
          div.className = "message " + (m.sender === user.email ? "me" : "other");
          div.textContent = `${m.sender}: ${m.text}`;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    });

    // é€å‡ºè¨Šæ¯
    sendBtn.onclick = async () => {
      const text = msgInput.value.trim();
      if (!text) return;
      const snap = await getDoc(chatRef);

      let messages = [];
      if (snap.exists()) {
        messages = snap.data().messages || [];
      }

      messages.push({
        sender: user.email,
        text,
        timestamp: new Date().toISOString()
      });

      await setDoc(chatRef, {
        participants: [teacherEmail, parentEmail],
        messages
      });
      msgInput.value = "";
      console.log("test");
    };
  </script>
</body>
</html>
