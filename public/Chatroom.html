<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>聊天室</title>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; margin: 0; padding: 0; }
    #messages { height: 60vh; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 20px; }
    .message { margin: 5px 0; }
    .me { text-align: right; color: blue; }
    .other { text-align: left; color: green; }
    #chatControls { margin: 20px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div id="navbar"></div>

  <h2 style="margin:20px;">📩 私密聊天室</h2>

  <div id="chatControls">
    <label for="userSelect">選擇聊天對象：</label>
    <select id="userSelect"></select>
    <button id="startChatBtn">開始聊天</button>
  </div>

  <div id="messages"></div>

  <div id="inputArea" style="margin:20px;">
    <input id="msgInput" type="text" placeholder="輸入訊息..." />
    <button id="sendBtn">送出</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, setDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    import { firebaseConfig } from "./fundamental.js";
    import { loadNavbar } from "./navbar.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userSelect = document.getElementById("userSelect");
    const startChatBtn = document.getElementById("startChatBtn");
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    let currentChatRef = null;
    let currentUser = null;
    let currentPartner = null;

    // ✅ 登入狀態
    onAuthStateChanged(auth, async (user) => {
      loadNavbar(auth, user);
      if (!user) {
        alert("請先登入！");
        window.location.href = "index.html";
        return;
      }
      currentUser = user;

      // 讀取所有使用者清單 (排除自己)
      const snapshot = await getDocs(collection(db, "users"));
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.email !== user.email) {
          const option = document.createElement("option");
          option.value = data.email;
          option.textContent = `${data.name || data.email} (${data.role})`;
          userSelect.appendChild(option);
        }
      });
    });

    // ✅ 開始聊天
    startChatBtn.onclick = () => {
      const partnerEmail = userSelect.value;
      if (!partnerEmail) return alert("請先選擇聊天對象！");
      currentPartner = partnerEmail;

      const chatId = [currentUser.email, partnerEmail].sort().join("_");
      currentChatRef = doc(db, "chats", chatId);

      // 監聽訊息
      onSnapshot(currentChatRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          messagesDiv.innerHTML = "";
          data.messages.forEach(m => {
            const div = document.createElement("div");
            div.className = "message " + (m.sender === currentUser.name ? "me" : "other");
            div.textContent = `${m.sender}: ${m.text}`;
            messagesDiv.appendChild(div);
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } else {
          messagesDiv.innerHTML = "<p style='color:gray'>目前沒有訊息，開始聊天吧！</p>";
        }
      });
    };

    // ✅ 送出訊息
    sendBtn.onclick = async () => {
      if (!currentChatRef || !currentPartner) return alert("請先選擇聊天對象！");
      const text = msgInput.value.trim();
      if (!text) return;

      const snap = await getDoc(currentChatRef);
      let messages = [];
      if (snap.exists()) {
        messages = snap.data().messages || [];
      }

      messages.push({
        sender: currentUser.email,
        text,
        timestamp: new Date().toISOString()
      });

      await setDoc(currentChatRef, {
        participants: [currentUser.email, currentPartner],
        messages
      });
      msgInput.value = "";
    };
  </script>
</body>
</html>