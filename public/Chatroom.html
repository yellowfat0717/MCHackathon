<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èŠå¤©å®¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-100 to-indigo-200 flex flex-col font-sans">

  <!-- ğŸ”µ Navbar -->
  <div class="bg-gradient-to-r from-purple-700 to-blue-500 text-white px-6 py-3 flex justify-between items-center shadow">
    <div class="flex items-center gap-4 font-bold">
      <span>ğŸ“š å­¸ç¿’ç¶²ç«™</span>
      <a href="index.html" class="hover:underline">ğŸ  å›é¦–é </a>
    </div>
    <div class="flex items-center gap-4">
      <span id="currentTime"></span>
      <span id="userInfo" class="bg-white/20 px-3 py-1 rounded-full text-sm">ğŸ‘¤ ä½¿ç”¨è€… (role)</span>
      <button class="underline font-bold">ğŸ’¬ èŠå¤©å®¤</button>
      <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-3 py-1 rounded text-sm">ç™»å‡º</button>
    </div>
  </div>

  <!-- ğŸŸ¦ èŠå¤©å¡ç‰‡ -->
  <div class="flex-1 flex justify-center items-center p-6">
    <div class="bg-white shadow-lg rounded-xl p-6 w-full max-w-3xl flex flex-col">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">ğŸ’¬ ç§å¯†èŠå¤©å®¤</h2>
      <p id="userRole" class="text-gray-600 mb-4">ğŸ‘¤ ä½¿ç”¨è€…ï¼ˆè§’è‰²ï¼‰</p>

      <!-- é¸æ“‡èŠå¤©å°è±¡ -->
      <div id="chatControls" class="flex items-center gap-3 mb-4">
        <label for="userSelect" class="text-gray-700">é¸æ“‡èŠå¤©å°è±¡ï¼š</label>
        <select id="userSelect" class="px-3 py-2 border rounded-lg flex-1"></select>
        <button id="startChatBtn" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">é–‹å§‹èŠå¤©</button>
      </div>

      <!-- èŠå¤©æ¨™é¡Œ -->
      <div id="chatHeader" class="font-semibold text-gray-700 mb-2 hidden"></div>

      <!-- ğŸ“Œ èŠå¤©ç´€éŒ„ (å›ºå®šé«˜åº¦ï¼Œå¯æ»‘å‹•) -->
      <div id="messages" class="border rounded-lg p-4 mb-2 bg-gray-50 h-[400px] overflow-y-auto"></div>
      <div id="typingIndicator" class="text-sm text-gray-500 italic mb-2 hidden">å°æ–¹æ­£åœ¨è¼¸å…¥ä¸­â€¦ âœ</div>

      <!-- è¼¸å…¥å€ -->
      <div id="inputArea" class="flex items-center gap-3">
        <textarea id="msgInput" rows="1" placeholder="è¼¸å…¥è¨Šæ¯..."
          class="flex-1 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none resize-none"></textarea>
        <button id="sendBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600">é€å‡º</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

    import { firebaseConfig } from "./fundamental.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const userSelect = document.getElementById("userSelect");
    const startChatBtn = document.getElementById("startChatBtn");
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const chatHeader = document.getElementById("chatHeader");
    const typingIndicator = document.getElementById("typingIndicator");

    const timeEl = document.getElementById("currentTime");
    const userInfo = document.getElementById("userInfo");
    const userRoleDisplay = document.getElementById("userRole");

    let currentChatRef = null;
    let currentUser = null;
    let currentPartner = null;
    let partnerName = null;

    function formatTime(isoStr) {
      const d = new Date(isoStr);
      return d.toLocaleTimeString("zh-TW", { hour: "2-digit", minute: "2-digit" });
    }

    function formatDateDivider(isoStr) {
      const d = new Date(isoStr);
      const today = new Date();
      const yesterday = new Date();
      yesterday.setDate(today.getDate() - 1);

      if (d.toDateString() === today.toDateString()) return "ä»Šå¤©";
      if (d.toDateString() === yesterday.toDateString()) return "æ˜¨å¤©";
      return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
    }

    // â° é¡¯ç¤ºæ™‚é–“
    function updateClock() {
      const now = new Date();
      timeEl.textContent = now.toLocaleString("zh-TW", {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // âœ… ç™»å…¥ç‹€æ…‹
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("è«‹å…ˆç™»å…¥ï¼");
        window.location.href = "index.html";
        return;
      }
      currentUser = user;

      // ğŸ”¹ å¾ sessionStorage æ‹¿åå­—å’Œè§’è‰²
      const displayName = sessionStorage.getItem("name") || user.displayName || user.email;
      const role = sessionStorage.getItem("role") || "æœªè¨­å®šè§’è‰²";

      userInfo.textContent = `ğŸ‘¤ ${displayName}ï¼ˆ${role}ï¼‰`;
      userRoleDisplay.textContent = `ğŸ‘¤ ${displayName}ï¼ˆ${role}ï¼‰`;

      // è®€å–æ‰€æœ‰ä½¿ç”¨è€…æ¸…å–® (æ’é™¤è‡ªå·±)
      const snapshot = await getDocs(collection(db, "users"));
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.email !== user.email) {
          const option = document.createElement("option");
          option.value = data.email;
          option.textContent = `${data.name || data.email} (${data.role})`;
          option.dataset.name = data.name || data.email;
          userSelect.appendChild(option);
        }
      });

      // ğŸ”” å•Ÿç”¨æ¡Œé¢é€šçŸ¥æ¬Šé™
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }
    });

    // âœ… ç™»å‡º
    logoutBtn.onclick = async () => {
      await signOut(auth);
      window.location.href = "index.html";
    };

    // âœ… é–‹å§‹èŠå¤©
    startChatBtn.onclick = () => {
      const partnerEmail = userSelect.value;
      if (!partnerEmail) return alert("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡ï¼");
      currentPartner = partnerEmail;
      partnerName = userSelect.selectedOptions[0].dataset.name;

      chatHeader.classList.remove("hidden");
      chatHeader.textContent = `èˆ‡ ${partnerName} çš„èŠå¤©`;

      const chatId = [currentUser.email, partnerEmail].sort().join("_");
      currentChatRef = doc(db, "chats", chatId);

      onSnapshot(currentChatRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          messagesDiv.innerHTML = "";

          let lastDate = null;
          data.messages.forEach(m => {
            const msgDate = new Date(m.timestamp).toDateString();
            if (lastDate !== msgDate) {
              const divider = document.createElement("div");
              divider.className = "text-center text-gray-400 text-sm my-2";
              divider.textContent = formatDateDivider(m.timestamp);
              messagesDiv.appendChild(divider);
              lastDate = msgDate;
            }
            const div = document.createElement("div");
            div.className = "flex flex-col " + (m.sender === currentUser.email ? "items-end" : "items-start");
            div.innerHTML = `
              <div class="px-4 py-2 rounded-lg max-w-[70%] ${m.sender === currentUser.email
                ? "bg-green-500 text-white rounded-br-sm"
                : "bg-white border text-gray-800 rounded-bl-sm"}">${m.text}</div>
              <div class="text-xs text-gray-500 mt-1">${formatTime(m.timestamp)}</div>
            `;
            messagesDiv.appendChild(div);

            // ğŸ”” æ–°è¨Šæ¯é€šçŸ¥ï¼ˆåƒ…é™å°æ–¹ & é é¢ä¸åœ¨å‰æ™¯ï¼‰
            if (m.sender !== currentUser.email && document.hidden && "Notification" in window && Notification.permission === "granted") {
              new Notification(`ğŸ“© ${partnerName} å‚³ä¾†æ–°è¨Šæ¯`, {
                body: m.text,
                icon: "https://cdn-icons-png.flaticon.com/512/2333/2333009.png"
              }).onclick = () => window.focus();
            }
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;

          // ğŸ”¹ é¡¯ç¤ºã€Œå°æ–¹è¼¸å…¥ä¸­ã€
          typingIndicator.classList.toggle("hidden", !(data.typing && data.typing === currentPartner));
        } else {
          messagesDiv.innerHTML = "<p class='text-gray-400 text-center'>ç›®å‰æ²’æœ‰è¨Šæ¯ï¼Œé–‹å§‹èŠå¤©å§ï¼</p>";
        }
      });
    };

    // âœ… é€å‡ºè¨Šæ¯
    async function sendMessage() {
      if (!currentChatRef || !currentPartner) return alert("è«‹å…ˆé¸æ“‡èŠå¤©å°è±¡ï¼");
      const text = msgInput.value.trim();
      if (!text) return;

      const snap = await getDoc(currentChatRef);
      let messages = [];
      if (snap.exists()) {
        messages = snap.data().messages || [];
      }
      messages.push({
        sender: currentUser.email,
        text,
        timestamp: new Date().toISOString()
      });

      await setDoc(currentChatRef, {
        participants: [currentUser.email, currentPartner],
        messages,
        typing: null
      });
      msgInput.value = "";
    }

    sendBtn.onclick = sendMessage;

    // âœ… Enter é€å‡º / Shift+Enter æ›è¡Œ
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // âœ… åµæ¸¬è¼¸å…¥ä¸­
    msgInput.addEventListener("input", async () => {
      if (!currentChatRef) return;
      await updateDoc(currentChatRef, { typing: currentUser.email });
      setTimeout(async () => {
        if (msgInput.value.trim() === "") {
          await updateDoc(currentChatRef, { typing: null });
        }
      }, 1500);
    });
  </script>
</body>
</html>